@using Portfolio.Services
@using Portfolio.Models
@using Portfolio.Components.Common
@inject PortfolioService PortfolioService
@inject LayoutState LayoutState
@implements IDisposable

<section id="projects" class="section">
    <div class="container">
        <div class="section-title-wrapper">
            <h2 class="section-title">Projects</h2>
            <p class="section-subtitle">
                <text>Personal initiatives showcasing technological experiments</text>
            </p>
        </div>

        <!-- Filters -->
        @if (!MaxCount.HasValue) 
        {
        <div class="filters-container">
             <!-- Search Filter -->
             <div>
                <label class="filter-group-label">Search</label>
                <div class="search-wrapper">
                    <input @bind="SearchQuery" @bind:event="oninput" type="text" placeholder="Search projects..." class="filter-input" />
                    <Icon Name="search" Class="search-icon w-4 h-4" />
                </div>
            </div>

            <!-- Domain Filter -->
            <div>
                <label class="filter-group-label">Domain</label>
                <select @bind="ActiveDomain" class="filter-select">
                    @foreach (var domain in Domains)
                    {
                        <option value="@domain">@domain</option>
                    }
                </select>
            </div>

            <!-- Technology Filter -->
            <div>
                <label class="filter-group-label">Technology</label>
                <select @bind="ActiveTech" class="filter-select">
                    @foreach (var tech in AllTechnologies)
                    {
                        <option value="@tech">@tech</option>
                    }
                </select>
            </div>
        </div>
        }

        <!-- Projects Grid -->
        <div class="projects-grid">
            @foreach (var project in FilteredProjects)
            {
                <div @onclick="() => SelectProject(project)" class="project-card group">
                    <!-- Placeholder Image -->
                    <div class="project-image-wrapper">
                         @if (!string.IsNullOrEmpty(project.Image))
                         {
                             <img src="@project.Image" alt="@project.Title" class="project-image" />
                         }
                         else
                         {
                             <div class="icon-placeholder">
                                <div class="icon-circle">
                                    <div class="icon-dot"></div>
                                </div>
                            </div>
                         }
                    </div>

                    <div class="card-content">
                        <div class="card-top">
                            <span class="domain-text">@project.Domain</span>
                             <div class="arrow-icon-wrapper">
                                <Icon Name="arrow-right" Class="w-4 h-4 icon-small" />
                            </div>
                        </div>

                        <h3 class="card-title">@project.Title</h3>

                         <div class="tech-tags">
                            @foreach (var tech in project.Technologies.Take(3))
                            {
                                <span class="tech-tag">@tech</span>
                            }
                             @if (project.Technologies.Count > 3)
                            {
                                <span class="tech-tag">+@(project.Technologies.Count - 3)</span>
                            }
                        </div>

                         <div class="card-actions">
                            @if (!string.IsNullOrEmpty(project.CodeUrl))
                            {
                                <a href="@project.CodeUrl" @onclick:stopPropagation target="_blank" rel="noopener noreferrer" class="action-link">
                                    <Icon Name="github" Class="w-4 h-4 icon-small" /> Code
                                </a>
                            }
                            @if (!string.IsNullOrEmpty(project.DemoUrl))
                            {
                                <a href="@project.DemoUrl" @onclick:stopPropagation target="_blank" rel="noopener noreferrer" class="action-link">
                                     <Icon Name="network" Class="w-4 h-4 icon-small" /> Demo
                                </a>
                            }
                         </div>
                    </div>
                </div>
            }
        </div>
        
        @if (!FilteredProjects.Any())
        {
             <div class="no-results">
              <p>No projects match the selected filters.</p>
            </div>
        }

        @if (MaxCount.HasValue && ProjectItems.Count > MaxCount.Value)
        {
            <div class="view-all-container">
                <button @onclick="NavigateToAllProjects" class="btn btn-primary btn-padded">
                     View All Projects
                </button>
            </div>
        }
    </div>

    <!-- Modal -->
    @if (SelectedProject != null)
    {
        <div class="modal-overlay" @onclick="CloseProject">
            <div class="modal-content" @onclick:stopPropagation>
                <div class="modal-inner">
                     <div class="modal-header">
                        <h3>@SelectedProject.Title</h3>
                        <button @onclick="CloseProject" class="close-btn">
                             <Icon Name="x" Class="h-6 w-6" />
                        </button>
                    </div>
                    <!-- Description -->
                    <p class="modal-description">@SelectedProject.Description</p>
                    
                    <!-- Highlights/Details -->
                    <h4 class="modal-subtitle">Key Highlights</h4>
                    <ul class="highlights-list">
                        @foreach (var highlight in SelectedProject.Highlights)
                        {
                            <li class="highlight-item">
                                <span>@highlight</span>
                            </li>
                        }
                    </ul>

                    <!-- Tech -->
                     <h4 class="modal-subtitle modal-subtitle-tech">Technologies</h4>
                    <div class="tech-tags">
                         @foreach (var tech in SelectedProject.Technologies)
                        {
                            <span class="tech-tag">@tech</span>
                        }
                    </div>

                    <!-- Links -->
                    <div class="card-actions modal-links">
                        @if (!string.IsNullOrEmpty(SelectedProject.CodeUrl))
                        {
                            <a href="@SelectedProject.CodeUrl" target="_blank" rel="noopener noreferrer" class="action-link">
                                <Icon Name="github" Class="w-5 h-5 icon-small" /> Code
                            </a>
                        }
                        @if (!string.IsNullOrEmpty(SelectedProject.DemoUrl))
                        {
                            <a href="@SelectedProject.DemoUrl" target="_blank" rel="noopener noreferrer" class="action-link">
                                    <Icon Name="network" Class="w-5 h-5 icon-small" /> Demo
                            </a>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</section>

@code {
    [Parameter]
    public int? MaxCount { get; set; }

    [Inject]
    private NavigationManager NavigationManager { get; set; } = default!;

    private List<ProjectModel> ProjectItems = new();
    private ProjectModel? SelectedProject => LayoutState.SelectedProject;
    private string ActiveDomain = "All";
    private string ActiveTech = "All";
    private string SearchQuery = "";

    private IEnumerable<string> Domains => new[] { "All" }.Concat(ProjectItems.Select(p => p.Domain).Distinct().OrderBy(d => d));
    private IEnumerable<string> AllTechnologies => new[] { "All" }.Concat(ProjectItems.SelectMany(p => p.Technologies).Distinct().OrderBy(t => t));

    protected override async Task OnInitializedAsync()
    {
        ProjectItems = await PortfolioService.GetProjectsAsync();
        LayoutState.OnChange += StateHasChanged;
    }

    public void Dispose()
    {
         LayoutState.OnChange -= StateHasChanged;
    }

    private void NavigateToAllProjects()
    {
        NavigationManager.NavigateTo("projects");
    }

    private void SelectProject(ProjectModel project)
    {
        LayoutState.SelectProject(project);
    }

    private void CloseProject()
    {
        LayoutState.SelectProject(null);
    }

    private IEnumerable<ProjectModel> FilteredProjects 
    {
        get
        {
             var query = ProjectItems.Where(p => 
                (string.IsNullOrWhiteSpace(SearchQuery) || 
                 p.Title.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase) || 
                 p.Description.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase)) &&
                (ActiveDomain == "All" || p.Domain == ActiveDomain) &&
                (ActiveTech == "All" || p.Technologies.Contains(ActiveTech))
            );

            if (MaxCount.HasValue)
            {
                return query.Where(p => p.Pin).Take(MaxCount.Value);
            }

            return query;
        }
    }
}
